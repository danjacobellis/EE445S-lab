

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Lab 7 Primer &mdash; 445S Lab Manual  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> 445S Lab Manual
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">EE 445S Lab Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primer.html">Lab Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stm32h735g.html">STM32H735G Discovery Kit Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Laboratory Hardware Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data.html">Managing data between MATLAB and C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting / Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab1/index.html">Lab 1. Overview of Hardware and Software Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab2/index.html">Lab 2. Generating Cosine and Sine Waves</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/index.html">Lab 3. Digital Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab4/primer.html">Lab 4 Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab4/index.html">Lab 4. Pseudo-Random Binary Sequences and Data Scramblers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/primer.html">Lab 5 Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/index.html">Lab 5. Digital Data Transmission by Baseband Pulse Amplitude Modulation (PAM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/primer.html">Lab 6 Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/index.html">Lab 6. Quadrature Amplitude Modulation (QAM)</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">445S Lab Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Lab 7 Primer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/lab7/primer.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="lab-7-primer">
<h1>Lab 7 Primer<a class="headerlink" href="#lab-7-primer" title="Permalink to this headline">¶</a></h1>
<div class="section" id="modeling-speech">
<h2>Modeling speech<a class="headerlink" href="#modeling-speech" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Source%E2%80%93filter_model">source-filter model</a> of speech is ubiquitous for speech synthesis.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NET</span><span class="o">.</span><span class="n">addAssembly</span><span class="p">(</span><span class="s1">&#39;System.Speech&#39;</span><span class="p">);</span>
<span class="n">speech_synth</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Speech</span><span class="o">.</span><span class="n">Synthesis</span><span class="o">.</span><span class="n">SpeechSynthesizer</span><span class="p">;</span>
<span class="n">Speak</span><span class="p">(</span><span class="n">speech_synth</span><span class="p">,</span><span class="s1">&#39;Put your hands up. This is a filter bank robbery&#39;</span><span class="p">);</span>
<span class="n">SetOutputToWaveFile</span><span class="p">(</span><span class="n">speech_synth</span><span class="p">,</span><span class="s1">&#39;example.wav&#39;</span><span class="p">);</span>
<span class="n">Speak</span><span class="p">(</span><span class="n">speech_synth</span><span class="p">,</span><span class="s1">&#39;Put your hands up. This is a filter bank robbery&#39;</span><span class="p">);</span>
</pre></div>
</div>
<audio controls="controls">
     <source src="../_static/example.wav" type="audio/wav">
</audio><p>The source is typically modeled based on the pressure wave that occurs when the vocal folds repeatedly open and close. We can model this as a pulse which is modulated by an impulse train.</p>
<p><img alt="" src="../_images/gauss_shah.svg" /></p>
<p>The pressure wave can be modeled as the derivative of this signal.</p>
<p><img alt="" src="../_images/ddt_gauss_shah.svg" /></p>
<p>In the frequency domain, the result is concentration of energy at evenly spaced harmonics</p>
<p><img alt="" src="../_images/gauss_shah_freq.svg" /></p>
<p>The spacing of these harmonics is ‘pitch’, and their envelope contains the remaining phonetic information.</p>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Vocoder">vocoder</a> attempts to to find the time-varying parameters to a speech model from a recording. Since the sophistication of speech models varies widely, so does the sophistication of vocoders. However, the main principles can be demonstrated with just a three subsystems: (1) a source model (above), (2) <a class="reference external" href="https://en.wikipedia.org/wiki/Pitch_detection_algorithm">pitch detection</a>, and (3) an <a class="reference external" href="https://en.wikipedia.org/wiki/Adaptive_filter">adaptive filter</a>.</p>
<p>A common application of the vocoder is to rencode the speech with a new frequency <span class="math notranslate nohighlight">\(f_c\)</span>.</p>
<p><img alt="" src="../_images/vocoder.svg" /></p>
</div>
<div class="section" id="autocorrelation-for-pitch-detection">
<h2>Autocorrelation for pitch detection<a class="headerlink" href="#autocorrelation-for-pitch-detection" title="Permalink to this headline">¶</a></h2>
<p>Suppose that we want to estimate the time-varying fundamental frequency <span class="math notranslate nohighlight">\(f_0\)</span> of a speech recording with an update rate of about 25 Hz. We can divide the input signal into frames which are roughly <span class="math notranslate nohighlight">\(\frac{1}{25 \text{ Hz}} = 40 \text{ ms}\)</span> long. For a sampling rate of 48 kHz, this would mean that we want to produce an estimate every <span class="math notranslate nohighlight">\(\frac{48 \text{ kHz}}{25 \text{ Hz}} = 1920\)</span> samples, though for convenience we will round this to to a power of two (2048).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">fs</span><span class="p">]</span> <span class="o">=</span> <span class="n">audioread</span><span class="p">(</span><span class="s1">&#39;example.wav&#39;</span><span class="p">);</span> <span class="n">y</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">320</span><span class="p">,</span><span class="mi">147</span><span class="p">);</span> <span class="n">fs</span> <span class="o">=</span> <span class="mf">48e3</span><span class="p">;</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">L</span><span class="p">);</span> <span class="n">y</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">y</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
<p>The fundamental period of the signal is <span class="math notranslate nohighlight">\(T_0 = 1/f_0\)</span>. Therefore, the autocorrelation should have a peak at this offset. This fact leads to a simple pitch detection algorithm.</p>
<ol class="simple">
<li><p>Find the offset <span class="math notranslate nohighlight">\(N_0\)</span> (in samples) where the peak autocorrelation occurs (subject to a constraint).</p></li>
<li><p>Estimate that the signal in the frame is periodic with fundamental frequency <span class="math notranslate nohighlight">\(\omega_0 = \frac{1}{N_0} \frac{\text{radians}}{\text{sample}}\)</span>.</p></li>
</ol>
<p>The constraint in step one is that the estimated frequency should be in the normal vocal range of about 50 to 250 Hz. Or equivalently, the offset should be between <span class="math notranslate nohighlight">\(\frac{48 \text{kHz}}{250 \text{Hz}} \approx 200\)</span> samples and <span class="math notranslate nohighlight">\(\frac{48 \text{kHz}}{50 \text{Hz}} \approx 1000\)</span> samples.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="o">@</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">)</span> <span class="o">.*</span> <span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="o">-</span><span class="n">n</span><span class="p">));</span>
<span class="n">Rn</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">N0</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="n">i_frame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="n">R_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">200</span><span class="p">:</span><span class="mi">1000</span>
    <span class="n">Rn</span><span class="p">(</span><span class="n">i_frame</span><span class="p">)</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span> <span class="n">y</span><span class="p">(:,</span><span class="n">i_frame</span><span class="p">),</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">Rn</span><span class="p">(</span><span class="n">i_frame</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">R_max</span>
        <span class="n">R_max</span> <span class="o">=</span> <span class="n">Rn</span><span class="p">(</span><span class="n">i_frame</span><span class="p">);</span> <span class="n">n_max</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">end</span>
    <span class="n">N0</span><span class="p">(</span><span class="n">i_frame</span><span class="p">)</span> <span class="o">=</span> <span class="n">n_max</span><span class="p">;</span>
    <span class="n">Rn</span><span class="p">(</span><span class="n">i_frame</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_max</span><span class="p">;</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="simple-model-of-vocal-source">
<h2>Simple model of vocal source<a class="headerlink" href="#simple-model-of-vocal-source" title="Permalink to this headline">¶</a></h2>
<p>Any waveform that matches the desired fundamental frequency and has energy widely distributed among harmonics is suitable to simulate the vocal source. For this example, we will use the (derivative of) a gaussian pulse which has been modulated by an impulse train of the desired period. We will use the magnitude of the autocorrelation to control the volume and avoid changing frequencies when no voiced speech is present.</p>
<p><img alt="" src="../_images/ddt_gauss_shah.svg" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x1</span> <span class="o">=</span> <span class="p">[];</span>
<span class="n">period</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
<span class="k">for</span> <span class="n">i_frame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
    <span class="k">if</span> <span class="n">Rn</span><span class="p">(</span><span class="n">i_frame</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">N0</span><span class="p">(</span><span class="n">i_frame</span><span class="p">);</span>
    <span class="n">end</span>
    <span class="n">waveform1</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">gausswin</span><span class="p">(</span><span class="n">period</span><span class="p">,</span><span class="mi">30</span><span class="p">));</span>
    <span class="k">for</span> <span class="n">i_sample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">L</span>
        <span class="n">i_x</span> <span class="o">=</span> <span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="n">i_frame</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">i_sample</span><span class="p">;</span>
        <span class="n">i_w</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">i_sample</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">waveform1</span><span class="p">));</span>
        <span class="n">i_w</span> <span class="o">=</span> <span class="n">i_w</span> <span class="o">+</span> <span class="p">(</span><span class="n">i_w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">x1</span><span class="p">(</span><span class="n">i_x</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">waveform1</span><span class="p">(</span><span class="n">i_w</span><span class="p">))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Rn</span><span class="p">(</span><span class="n">i_frame</span><span class="p">));</span>
        <span class="k">if</span> <span class="n">i_sample</span> <span class="o">&gt;</span> <span class="n">L</span> <span class="o">-</span> <span class="n">period</span>
            <span class="n">x1</span><span class="p">(</span><span class="n">i_x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x1</span><span class="p">(</span><span class="n">i_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">L</span> <span class="o">-</span> <span class="n">i_sample</span><span class="p">)</span><span class="o">/</span><span class="n">period</span><span class="p">);</span>
        <span class="n">end</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="modeling-the-vocal-tract">
<h2>Modeling the vocal tract<a class="headerlink" href="#modeling-the-vocal-tract" title="Permalink to this headline">¶</a></h2>
<p>Now that we have a model of the source, we can attempt to learn (for each new sample) an LTI approximation of the articulatory filter (lips, tounge, pharynx, etc). Many adaptive filtering techniques exist for this task, but for simplicity we will use the <a class="reference external" href="https://en.wikipedia.org/wiki/Least_mean_squares_filter">Least mean square filter</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">x1</span><span class="p">));</span>
<span class="n">n</span><span class="o">=</span><span class="mi">513</span><span class="p">;</span> <span class="n">h</span><span class="o">=</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">mu</span><span class="o">=</span><span class="mf">.001</span><span class="p">;</span> <span class="n">delta</span><span class="o">=</span><span class="mi">256</span><span class="p">;</span>
<span class="n">p1</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="n">i_sample</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">(</span><span class="n">i_sample</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">i_sample</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="s1">&#39;;</span>
    <span class="n">p1</span><span class="p">(</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">h</span><span class="p">);</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">i_sample</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span> <span class="o">-</span> <span class="n">p1</span><span class="p">(</span><span class="n">end</span><span class="p">);</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">+</span> <span class="n">mu</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">t1</span><span class="p">;</span>
<span class="n">end</span>
<span class="n">soundsc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
<audio controls="controls">
     <source src="../_static/example2.wav" type="audio/wav">
</audio></div>
<div class="section" id="applications">
<h2>Applications<a class="headerlink" href="#applications" title="Permalink to this headline">¶</a></h2>
<p>The examples above encode the speech into a time-varying frequeny <span class="math notranslate nohighlight">\(f_0\)</span> and a time-varying filter <span class="math notranslate nohighlight">\(h\)</span>. With this description of the signal, many applications are possible:</p>
<ul class="simple">
<li><p>Replace the source with a musical instrument with energetic harmonics, (like a guitar, violin, or synthesizer), but use the learned time-varying filter to make the instrument ‘speak’.</p></li>
<li><p>Exploit the fact that the parameterized representation contains fewer bits for speech compression.</p></li>
<li><p>Modify the parameters based on other information about the signal to perform denoising or source separation.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>